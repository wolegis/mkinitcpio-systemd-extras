#!/bin/bash

build() {
    if ! pacman -Qi tinyssh >/dev/null 2>&1; then
        error "Package tinyssh not installed"
        return 1
    fi

    if ! pacman -Qi tpm2-tss >/dev/null 2>&1; then
        error "Package tpm2-tss not installed (required for TPM2-sealed SSH host key)"
        return 1
    fi

    add_systemd_unit tinyssh@.socket
    add_systemd_unit tinyssh@.service

    # enable tinysshd listening on TCP port $SD_TINYSSH_PORT (if set to legal port number)
    SD_TINYSSH_PORT="${SD_TINYSSH_PORT:-22}"
    if (( SD_TINYSSH_PORT < 1 || SD_TINYSSH_PORT > 65535 )); then
        error "Illegal value SD_TINYSSH_PORT=$SD_TINYSSH_PORT"
        return 1
    fi
    add_symlink "/etc/systemd/system/sysinit.target.wants/tinyssh@$SD_TINYSSH_PORT.socket" /usr/lib/systemd/system/tinyssh@.socket

    # --- Host key handling (TPM2-sealed only) ---
    local keydir="${SD_TINYSSH_KEYDIR:-/etc/tinyssh/sshkeydir}"

    if [[ ! -r "$keydir/ed25519.pk" ]]; then
        error "Public key '$keydir/ed25519.pk' not found (or not readable)."
        error "Generate keys first:  tinysshd-makekey $keydir"
        return 1
    fi
    if [[ ! -r "$keydir/.ed25519.sk.cred" ]]; then
        error "TPM2-sealed secret key '$keydir/.ed25519.sk.cred' not found (or not readable)."
        error "Seal the secret key with:"
        error "  systemd-creds encrypt --with-key=tpm2 --tpm2-pcrs=0+7 --name=tinyssh-hostkey \\"
        error "      $keydir/.ed25519.sk $keydir/.ed25519.sk.cred"
        return 1
    fi

    # systemd-creds and its direct library deps
    add_binary systemd-creds

    # libtss2-tcti-device.so is dlopen'd by tpm2-tss at runtime and thus
    # not pulled in automatically by add_binary
    local lib
    for lib in /usr/lib/libtss2-tcti-device.so*; do
        [[ -e "$lib" ]] && add_file "$lib"
    done

    # Copy public key (plaintext) and sealed secret key into initramfs
    add_file "$keydir/ed25519.pk" /etc/tinyssh/sshkeydir/ed25519.pk
    add_file "$keydir/.ed25519.sk.cred" /etc/tinyssh/sshkeydir/.ed25519.sk.cred

    # Generate a oneshot service that decrypts the sealed host key at boot.
    # The decrypted key is written to the initramfs tmpfs and only lives in
    # memory — it never touches persistent storage.
    printf "%s\n" \
        "[Unit]" \
        "Description=Decrypt TinySSH host key from TPM2" \
        "DefaultDependencies=no" \
        "" \
        "[Service]" \
        "Type=oneshot" \
        "RemainAfterExit=yes" \
        "UMask=0077" \
        "ExecStart=/usr/bin/systemd-creds decrypt --tpm2-device=auto --name=tinyssh-hostkey /etc/tinyssh/sshkeydir/.ed25519.sk.cred /etc/tinyssh/sshkeydir/.ed25519.sk" \
        > "$BUILDROOT/usr/lib/systemd/system/tinyssh-hostkey-decrypt.service"
    chmod 644 "$BUILDROOT/usr/lib/systemd/system/tinyssh-hostkey-decrypt.service"

    # Enable the decrypt service in sysinit
    add_symlink "/etc/systemd/system/sysinit.target.wants/tinyssh-hostkey-decrypt.service" \
                /usr/lib/systemd/system/tinyssh-hostkey-decrypt.service

    # --- Socket drop-in ---
    local drop_in=(
        '[Unit]'
        'Requires=systemd-networkd.service tinyssh-hostkey-decrypt.service'
        'After=systemd-networkd.service tinyssh-hostkey-decrypt.service'
        'DefaultDependencies=no'
    )
    printf "%s\n" "${drop_in[@]}" | add_systemd_drop_in "tinyssh@$SD_TINYSSH_PORT.socket" override

    # --- Service drop-in ---
    drop_in=(
        "[Unit]"
        "DefaultDependencies=no"
        ""
        "[Service]"
        "ExecStart="
        "ExecStart=-/usr/bin/tinysshd ${SD_TINYSSH_COMMAND:+-e '${SD_TINYSSH_COMMAND}' }/etc/tinyssh/sshkeydir"
    )
    printf "%s\n" "${drop_in[@]}" | add_systemd_drop_in tinyssh@.service override

    # --- Authorized keys ---
    SD_TINYSSH_AUTHORIZED_KEYS=${SD_TINYSSH_AUTHORIZED_KEYS:-/root/.ssh/authorized_keys}
    if [[ ! -r "$SD_TINYSSH_AUTHORIZED_KEYS" ]]; then
        error "Keys file '$SD_TINYSSH_AUTHORIZED_KEYS' does not exist (or not readable)"
        return 1
    fi
    add_dir /root/.ssh
    grep '^ssh-ed25519 ' "$SD_TINYSSH_AUTHORIZED_KEYS" >"$BUILDROOT/root/.ssh/authorized_keys"
    if [[ -s "$BUILDROOT/root/.ssh/authorized_keys" ]]; then
        chmod 600 "$BUILDROOT/root/.ssh/authorized_keys"
        chmod 700 "$BUILDROOT/root/.ssh"
    else
        error "No ED25519 key found for root"
        return 1
    fi

    if [[ -z "$SD_TINYSSH_COMMAND" && -r "$SD_TINYSSH_SCRIPT" ]]; then
        add_file "$SD_TINYSSH_SCRIPT" /root/.profile 600
    fi
}

help() {
    cat <<__EOF_HELP__
This hook enables tinyssh within a systemd based initramfs, with the server's
secret key sealed to the machine's TPM2 chip via systemd-creds.

The sealed credential (.ed25519.sk.cred) is embedded in the initramfs image.
At boot a oneshot service decrypts it into the initramfs tmpfs, so the
plaintext secret key only ever exists in memory — it never touches persistent
storage.

PREPARATION

 1. Generate tinyssh host keys (if not already present):

      tinysshd-makekey /etc/tinyssh/sshkeydir

 2. Seal the secret key to the TPM2 chip:

      systemd-creds encrypt \\
          --with-key=tpm2 \\
          --tpm2-pcrs=0+7 \\
          --name=tinyssh-hostkey \\
          /etc/tinyssh/sshkeydir/.ed25519.sk \\
          /etc/tinyssh/sshkeydir/.ed25519.sk.cred

 3. Remove the plaintext secret key (keep an offline backup!):

      rm /etc/tinyssh/sshkeydir/.ed25519.sk

 4. Rebuild the initramfs:

      mkinitcpio -P

PCR POLICY

    --tpm2-pcrs=0+7 binds decryption to PCR 0 (firmware) and PCR 7 (Secure
    Boot state).  After a firmware update or Secure Boot policy change the
    key must be re-sealed (repeat steps 2-4 above).

    WARNING: If --tpm2-pcrs is omitted the credential is bound to the TPM
    chip alone.  This means anyone who can boot ANY operating system on the
    machine (e.g. from a USB stick) will be able to unseal and read the
    secret key.  It is therefore strongly recommended to seal against at
    least PCR 0 and PCR 7 (--tpm2-pcrs=0+7).

VARIABLES (set in /etc/mkinitcpio.conf)

    SD_TINYSSH_KEYDIR
        Directory containing ed25519.pk and .ed25519.sk.cred.
        Default: /etc/tinyssh/sshkeydir

    SD_TINYSSH_PORT
        TCP port tinyssh listens on.  Default: 22

    SD_TINYSSH_AUTHORIZED_KEYS
        Authorized-keys file for root.  Default: /root/.ssh/authorized_keys

    SD_TINYSSH_COMMAND
        Shell command executed instead of an interactive shell.  Example:
        SD_TINYSSH_COMMAND="systemd-tty-ask-password-agent --query --watch"

    SD_TINYSSH_SCRIPT
        File with shell commands executed before the interactive shell.
        Ignored when SD_TINYSSH_COMMAND is set.

See https://github.com/wolegis/mkinitcpio-systemd-extras/wiki/TinySSH-server
for details.
__EOF_HELP__
}
